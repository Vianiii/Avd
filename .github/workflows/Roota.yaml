name: avdroot

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm
      
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - uses: android-actions/setup-android@v3
      
      - name: Download System Image
        run: |
          yes | sdkmanager --licenses
          sdkmanager "system-images;android-30;google_apis;x86_64"
          sdkmanager "platform-tools"
          sdkmanager "emulator"
      
      - name: Install Rooted Files
        run: |
          wget https://github.com/Vianiii/Avd/releases/download/v1.0/rooted-avd.tar.gz
          tar -xzf rooted-avd.tar.gz -C $ANDROID_HOME/system-images/android-30/google_apis/x86_64/
          ls -lh $ANDROID_HOME/system-images/android-30/google_apis/x86_64/ | head -20
      
      - name: Create AVD Directory Structure
        run: |
          mkdir -p ~/.android/avd/test.avd
          
          cat > ~/.android/avd/test.ini << 'EOF'
          avd.ini.encoding=UTF-8
          path=/home/runner/.android/avd/test.avd
          target=android-30
          EOF
          
          cat > ~/.android/avd/test.avd/config.ini << 'EOF'
          AvdId=test
          PlayStore.enabled=false
          abi.type=x86_64
          hw.accelerometer=yes
          hw.audioInput=yes
          hw.battery=yes
          hw.device.name=pixel_5
          hw.dPad=yes
          hw.gps=yes
          hw.gpu.enabled=yes
          hw.gpu.mode=auto
          hw.initialOrientation=Portrait
          hw.keyboard=yes
          hw.lcd.density=420
          hw.mainKeys=no
          hw.ramSize=8192
          hw.sdCard=yes
          hw.sensors.orientation=yes
          hw.sensors.proximity=yes
          hw.touchScreen=yes
          hw.useext4=yes
          image.sysdir.1=system-images/android-30/google_apis/x86_64/
          sdcard.size=512M
          showDeviceFrame=no
          skin.dynamic=yes
          vm.heapSize=512
          EOF
          
          echo "AVD config created!"
          ls -la ~/.android/avd/
          ls -la ~/.android/avd/test.avd/
          cat ~/.android/avd/test.avd/config.ini
      
      - name: Verify Emulator Can See AVD
        run: |
          $ANDROID_HOME/emulator/emulator -list-avds
      
      - name: Setup FRP Tunnel
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xzf frp_0.58.1_linux_amd64.tar.gz
          sudo cp frp_0.58.1_linux_amd64/frpc /tmp/frpc
          
          cat > frpc.toml << 'EOF'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          transport.protocol = "kcp"
          [[proxies]]
          name = "adb"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5555
          remotePort = 5555
          EOF
          
          nohup /tmp/frpc -c frpc.toml > frpc.log 2>&1 &
          sleep 3
          echo "FRP tunnel started"
      
      - name: Boot Rooted Emulator
        run: |
          echo "Starting emulator with rooted ramdisk..."
          nohup $ANDROID_HOME/emulator/emulator -avd test -no-window -no-audio -no-snapshot-save -no-boot-anim -gpu swiftshader_indirect -memory 8192 2>&1 &
          
          sleep 45
          
          echo "Waiting for device..."
          adb wait-for-device
          
          echo "Waiting for boot completion..."
          for i in {1..60}; do
            BOOT=$(adb shell getprop sys.boot_completed 2>/dev/null)
            if [ "$BOOT" = "1" ]; then
              echo "Boot completed!"
              break
            fi
            echo "Attempt $i: Boot status = $BOOT"
            sleep 3
          done
          
          sleep 15
          
          echo "Device info:"
          adb shell getprop ro.product.cpu.abi
          adb shell getprop sys.boot_completed
          
          echo "Setting up ADB over TCP..."
          adb tcpip 5555
          sleep 3
          adb connect 127.0.0.1:5555
          
          echo ""
          echo "================================================"
          echo "âœ… ROOTED ANDROID 11 EMULATOR READY!"
          echo "================================================"
          echo ""
          echo "FROM TERMUX ON YOUR PHONE, RUN:"
          echo "  adb connect 159.195.6.61:5555"
          echo ""
          echo "THEN INSTALL GAMEGUARDIAN:"
          echo "  adb install /storage/emulated/0/Download/GameGuardian.apk"
          echo ""
          echo "ROOT: Magisk is integrated in ramdisk.img"
          echo "GameGuardian WILL detect root!"
          echo "================================================"
          echo ""
          
          sleep 21600
      
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: frpc.log
