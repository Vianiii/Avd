name: avd-auto-root-magisk-fixed

on:
  workflow_dispatch:
    inputs:
      duration:
        default: '6'

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm
      
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - uses: android-actions/setup-android@v3
      
      - name: Download System Image
        run: |
          echo "y" | sdkmanager --licenses
          echo "y" | sdkmanager "platform-tools"
          echo "y" | sdkmanager "emulator"
          sdkmanager --install "system-images;android-30;google_apis;x86_64"
      
      - name: Download rootAVD
        run: |
          wget https://github.com/newbit1/rootAVD/archive/refs/heads/master.zip
          unzip master.zip
          chmod +x rootAVD-master/rootAVD.sh
      
      - name: Create AVD with proper paths
        run: |
          mkdir -p $HOME/.android/avd
          echo "no" | avdmanager create avd --force --name test --package "system-images;android-30;google_apis;x86_64" --device "pixel_5"
          ls -la $HOME/.android/avd/
      
      - name: Install FRP
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xzf frp_0.58.1_linux_amd64.tar.gz
          sudo cp frp_0.58.1_linux_amd64/frpc /tmp/frpc
          cat > frpc.toml << 'EOF'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          transport.protocol = "kcp"
          [[proxies]]
          name = "adb"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5555
          remotePort = 5555
          EOF
          nohup /tmp/frpc -c frpc.toml > frpc.log 2>&1 &
      
      - name: Start AVD
        run: |
          nohup $ANDROID_HOME/emulator/emulator -avd test -no-window -no-audio -no-snapshot-save -gpu swiftshader_indirect -memory 8192 &
          $ANDROID_HOME/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d "
") ]]; do sleep 1; done'
          sleep 20
          echo "AVD booted successfully"
      
      - name: Root AVD with Magisk
        run: |
          cd rootAVD-master
          ./rootAVD.sh $ANDROID_HOME/system-images/android-30/google_apis/x86_64/ramdisk.img
          
          echo "Rebooting to apply root..."
          adb reboot
          sleep 5
          adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d "
") ]]; do sleep 1; done'
          sleep 30
          
          echo "Checking root..."
          adb shell su -c id || echo "Root check failed, but might work with GameGuardian"
      
      - name: Setup Remote Access
        run: |
          adb tcpip 5555
          sleep 3
          adb connect 127.0.0.1:5555
          
          echo ""
          echo "============================================"
          echo "âœ… Rooted AVD with Magisk Ready!"
          echo "============================================"
          echo ""
          echo "ðŸ“± Connect from Termux:"
          echo "   adb connect 159.195.6.61:5555"
          echo ""
          echo "ðŸŽ® Install GameGuardian:"
          echo "   adb install GameGuardian.apk"
          echo ""
          echo "ðŸ”“ Root: Magisk installed!"
          echo "   GameGuardian should detect root"
          echo ""
          echo "============================================"
          echo ""
          
          sleep $((3600 * ${{ inputs.duration }}))
      
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}
          path: frpc.log
          retention-days: 7
