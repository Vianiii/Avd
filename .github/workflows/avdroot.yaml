name: avd-android11-browser-rooted

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session hours (max 6)'
        required: false
        default: '6'

jobs:
  run-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Free Up Space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Download System Image with Browser
        run: |
          echo "üì• Downloading Android 11 with Chrome + Play Store..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-30;google_apis_playstore;x86_64"
          echo "‚úÖ System image with browser downloaded"

      - name: Download rootAVD
        run: |
          echo "üì• Downloading rootAVD for Magisk..."
          wget -q https://gitlab.com/newbit/rootAVD/-/archive/master/rootAVD-master.tar.gz
          tar -xzf rootAVD-master.tar.gz
          chmod +x rootAVD-master/rootAVD.sh
          echo "‚úÖ rootAVD ready"

      - name: Install FRP
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xzf frp_0.58.1_linux_amd64.tar.gz
          sudo cp frp_0.58.1_linux_amd64/frpc /usr/local/bin/
          sudo chmod +x /usr/local/bin/frpc

      - name: Create FRP Config
        run: |
          cat > frpc.toml << 'EOF'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          transport.protocol = "kcp"
          
          [[proxies]]
          name = "adb"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5555
          remotePort = 5555
          EOF

      - name: Start FRP
        run: |
          nohup frpc -c frpc.toml > frpc.log 2>&1 &
          sleep 3

      - name: Create Monitor
        run: |
          cat > monitor.sh << 'SCRIPT'
          #!/bin/bash
          HOURS=$1
          SECS=$((3600 * HOURS))
          START=$(date +%s)
          
          echo ""
          echo "========================================="
          echo "Session: ${HOURS}h | VPS: 159.195.6.61:5555"
          echo "========================================="
          echo ""
          
          ITER=0
          while true; do
            NOW=$(date +%s)
            ELAPSED=$((NOW - START))
            [ $ELAPSED -ge $SECS ] && echo "‚úÖ Complete" && break
            
            REMAIN=$((SECS - ELAPSED))
            H=$((REMAIN / 3600))
            M=$(((REMAIN % 3600) / 60))
            
            ITER=$((ITER + 1))
            [ $((ITER % 60)) -eq 0 ] && echo "[$(date '+%H:%M:%S')] ${H}h ${M}m left"
            
            sleep 1
          done
          SCRIPT
          chmod +x monitor.sh

      - name: Install Magisk Root
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis_playstore
          arch: x86_64
          profile: pixel_6_pro
          ram-size: 6144M
          disk-size: 12288M
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -writable-system
          disable-animations: true
          force-avd-creation: true
          script: |
            echo "========================================="
            echo "Installing Magisk Root"
            echo "========================================="
            
            adb wait-for-device
            sleep 15
            
            # Verify browser is present
            echo "üì± Checking for Chrome..."
            adb shell pm list packages | grep chrome && echo "   ‚úÖ Chrome installed" || echo "   ‚ö†Ô∏è  Chrome not found"
            
            # Root with rootAVD
            echo "üîì Installing Magisk..."
            RAMDISK="$ANDROID_HOME/system-images/android-30/google_apis_playstore/x86_64/ramdisk.img"
            
            if [ -f "$RAMDISK" ]; then
              cd rootAVD-master
              bash ./rootAVD.sh "$RAMDISK"
              cd ..
              echo "‚úÖ Magisk installed"
            else
              echo "‚ùå Ramdisk not found at: $RAMDISK"
              exit 1
            fi

      - name: Run Rooted Emulator with Browser
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis_playstore
          arch: x86_64
          profile: pixel_6_pro
          ram-size: 6144M
          disk-size: 12288M
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -writable-system -memory 6144 -cores 4
          disable-animations: true
          script: |
            echo ""
            echo "========================================="
            echo "   üöÄ Android 11 + Chrome + Magisk Root"
            echo "   üéÆ GameGuardian Ready"
            echo "========================================="
            echo ""
            
            adb wait-for-device
            sleep 20
            
            echo "üì± Enabling ADB TCP..."
            adb tcpip 5555
            sleep 5
            adb connect 127.0.0.1:5555
            sleep 3
            
            echo ""
            echo "üîì Root Status:"
            adb shell pm list packages | grep magisk && echo "   ‚úÖ Magisk installed" || echo "   ‚ö†Ô∏è  Magisk not found"
            adb shell "su -c 'echo Root works'" 2>/dev/null && echo "   ‚úÖ su binary working" || echo "   ‚ö†Ô∏è  su needs configuration"
            
            echo ""
            echo "üåê Browser Status:"
            adb shell pm list packages | grep chrome && echo "   ‚úÖ Chrome installed" || echo "   ‚ö†Ô∏è  Chrome not found"
            
            echo ""
            echo "üì¶ Play Store Status:"
            adb shell pm list packages | grep vending && echo "   ‚úÖ Play Store available" || echo "   ‚ö†Ô∏è  Play Store not found"
            
            echo ""
            echo "========================================="
            echo "üì± Connect: adb connect 159.195.6.61:5555"
            echo ""
            echo "üåê Launch Chrome:"
            echo "   adb shell am start -n com.android.chrome/com.google.android.apps.chrome.Main"
            echo ""
            echo "üéÆ Install GameGuardian:"
            echo "   adb install GameGuardian.apk"
            echo ""
            echo "üì¶ Launch Play Store:"
            echo "   adb shell am start -a android.intent.action.MAIN -c android.intent.category.LAUNCHER com.android.vending"
            echo ""
            echo "‚úÖ Chrome browser + Root access ready"
            echo "========================================="
            echo ""
            
            ./monitor.sh ${{ github.event.inputs.duration }}

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}
          path: |
            frpc.log
            rootAVD-master/*.log
          retention-days: 7
